#:kivy 1.11.1
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp
#:import FadeTransition kivy.uix.screenmanager.FadeTransition

# Custom button for the bottom navigation bar
<NavButton@ToggleButton>:
    background_color: 0,0,0,0 # Transparent background
    background_normal: ''
    background_down: '' # No visual change on press, handled by color
    size_hint_y: 1
    font_size: '12sp'
    group: 'nav' # Ensures only one can be active at a time
    on_press: app.change_screen(self.screen_name)
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['accent']) if self.state == 'down' else (0,0,0,0)
        Rectangle:
            size: self.size
            pos: self.pos

<RootWidget>:
    orientation: 'vertical'
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['background'])
        Rectangle:
            pos: self.pos
            size: self.size
            
    # Top bar for showing current screen title
    BoxLayout:
        id: top_bar
        size_hint_y: None
        height: dp(56)
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['navbar'])
            Rectangle:
                pos: self.pos
                size: self.size
        Label:
            id: top_bar_title
            text: 'HushOS'
            font_size: '24sp'
            color: get_color_from_hex(app.theme.COLORS['text_light'])

    # Main content area
    ScreenManager:
        id: sm
        transition: FadeTransition(duration=0.2)
        # Screens are added here
        SplashScreen:
            name: 'splash'
        JerryScreen:
            name: 'jerry'
        CheckinScreen:
            name: 'checkin'
        EntriesScreen:
            name: 'entries'
        HistoryScreen:
            name: 'history'
        HushScreen:
            name: 'hush'
        CBTScreen:
            name: 'cbt'
        DBTScreen:
            name: 'dbt'

    # Affirmation Banner (now part of the root layout)
    Label:
        id: affirmation_banner
        size_hint_y: None
        height: 0 # Hidden by default
        text: ""
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['accent'])
            Rectangle:
                pos: self.pos
                size: self.size
        color: get_color_from_hex(app.theme.COLORS['text_dark'])
        text_size: self.width - dp(20), None
        halign: 'center'
        valign: 'middle'

    # Bottom Navigation Bar
    BoxLayout:
        id: nav_bar
        size_hint_y: None
        height: dp(60)
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['navbar'])
            Rectangle:
                pos: self.pos
                size: self.size
        
        NavButton:
            text: 'Home'
            screen_name: 'jerry'
            state: 'down' # Start on the home screen
        NavButton:
            text: 'Check-in'
            screen_name: 'checkin'
        NavButton:
            text: 'Entries'
            screen_name: 'entries'
        NavButton:
            text: 'Hush'
            screen_name: 'hush'

# --- Screen Definitions ---

<SplashScreen>:
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['navbar'])
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        text: "Hush OS"
        font_size: '60sp'
        bold: True
        color: get_color_from_hex(app.theme.COLORS['text_light'])

<JerryScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        spacing: dp(5)
        
        JerryAnimator:
            id: animator
            size_hint_y: 0.35

        GridLayout:
            cols: 2
            size_hint_y: None
            height: dp(100)
            spacing: dp(5)
            Label:
                text: 'Clarity'
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
            ProgressBar:
                id: clarity_bar
                max: 100
            Label:
                text: 'Insight'
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
            ProgressBar:
                id: insight_bar
                max: 100
            Label:
                text: 'Calm'
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
            ProgressBar:
                id: calm_bar
                max: 100

        Label:
            id: level_label
            size_hint_y: None
            height: dp(20)
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ProgressBar:
            id: xp_bar
            size_hint_y: None
            height: dp(10)
            max: 100

        ScrollView:
            size_hint_y: 0.5
            canvas.before:
                Color:
                    rgba: get_color_from_hex(app.theme.COLORS['chat_bg'])
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                id: chat_log
                text: ""
                markup: True
                font_size: '14sp'
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width, None
                padding: dp(10), dp(10)

        BoxLayout:
            size_hint_y: None
            height: dp(48)
            TextInput:
                id: user_entry
                multiline: False
                on_text_validate: root.send_message()
            Button:
                id: send_button
                text: 'Send'
                size_hint_x: None
                width: dp(80)
                on_press: root.send_message()

<CheckinScreen>:
    canvas.before:
        Color:
            rgba: root.bg_color # Bind to the screen's bg_color property
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        id: content
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)

<EntriesScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        Label:
            text: 'Your Entries'
            font_size: '24sp'
            size_hint_y: None
            height: dp(40)
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ScrollView:
            Label:
                id: entries_log
                text: ""
                markup: True
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width, None
                padding: dp(10), dp(10)

<HistoryScreen>:
    # This screen is not in the nav bar, but can be accessed via chat
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        Label:
            text: 'Conversation History'
            font_size: '24sp'
            size_hint_y: None
            height: dp(40)
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ScrollView:
            Label:
                id: history_log
                text: ""
                markup: True
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width, None
                padding: dp(10), dp(10)

<HushScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        
        Label:
            text: "Find a moment of peace." if not root.timer_active else "Breathe..."
            font_size: '24sp'
            color: get_color_from_hex(app.theme.COLORS['text_dark'])

        Label:
            text: root.get_timer_text()
            font_size: '60sp'
            bold: True
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
            opacity: 1 if root.timer_active else 0

        Button:
            text: "Start 3 Minute Hush Session"
            on_press: root.start_timer()
            opacity: 0 if root.timer_active else 1
            disabled: root.timer_active
            size_hint_y: None
            height: dp(50)

<CBTScreen>:
    BoxLayout:
        id: content
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)

<DBTScreen>:
    BoxLayout:
        id: content
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)