#:kivy 1.11.1
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp

# --- Reusable Component & Base Class Definitions ---

<NavDrawerButton@Button>:
    screen_name: ''
    size_hint_y: None
    height: dp(56)
    background_color: 0, 0, 0, 0
    background_normal: ''
    on_press: app.change_screen(self.screen_name)
    text_size: self.width - dp(32), None
    halign: 'left'
    valign: 'middle'
    color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

# This rule now applies a background to ANY screen that doesn't have one,
# simplifying the rules below. This is a more robust way to define a base style.
<Screen>:
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['background']) if app else (0.53, 0.81, 0.98, 1)
        Rectangle:
            pos: self.pos
            size: self.size

<TitleLabel@Label>:
    font_size: '24sp'
    size_hint_y: None
    height: self.texture_size[1]
    color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

<BodyScrollView@ScrollView>:
    Label:
        id: body_text
        markup: True
        size_hint_y: None
        height: self.texture_size[1]
        text_size: self.width - dp(20), None
        color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

# --- Root Widget Definition ---

<RootWidget@NavigationLayout>:
    id: nav_layout
    
    # This is the side panel for the navigation drawer
    BoxLayout:
        id: drawer
        orientation: 'vertical'
        size_hint_x: None
        width: dp(280)
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['background']) if app else (0.9, 0.9, 0.9, 1)
            Rectangle:
                pos: self.pos
                size: self.size

        TitleLabel:
            text: "Menu"
            padding: dp(16), dp(16)

        NavDrawerButton:
            text: "Jerry"
            screen_name: 'jerry'
        NavDrawerButton:
            text: "Check-in"
            screen_name: 'checkin'
        NavDrawerButton:
            text: "CBT Worksheet"
            screen_name: 'cbt'
        NavDrawerButton:
            text: "DBT Skills Log"
            screen_name: 'dbt'
        NavDrawerButton:
            text: "All Entries"
            screen_name: 'entries'
        NavDrawerButton:
            text: "Conversation History"
            screen_name: 'history'
        NavDrawerButton:
            text: "Hush"
            screen_name: 'hush'

        Widget: # This is a spacer to push the version label to the bottom
        Label:
            text: "Version 1.0"
            font_size: '12sp'
            size_hint_y: None
            height: dp(24)
            color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

    # This is the main content area of the app
    BoxLayout:
        orientation: 'vertical'
        size_hint: 1, 1

        # TOP BAR
        BoxLayout:
            size_hint_y: None
            height: dp(56)
            padding: dp(8)
            spacing: dp(8)
            canvas.before:
                Color:
                    rgba: get_color_from_hex(app.theme.COLORS['navbar']) if app else (0.7, 0.9, 1, 1)
                Rectangle:
                    pos: self.pos
                    size: self.size
            Button:
                text: "\u2630" # Hamburger menu icon
                size_hint_x: None
                width: dp(50)
                on_press: nav_layout.toggle_nav_drawer()
                background_color: 0, 0, 0, 0
                font_size: '24sp'
            Label:
                text: "HushOS"
                font_size: '20sp'

        # AFFIRMATION BANNER
        Label:
            id: affirmation_banner
            size_hint_y: None
            height: 0 # Hidden by default
            text_size: self.width - dp(20), None
            valign: 'middle'
            halign: 'center'

        # SCREEN MANAGER
        ScreenManager:
            id: sm
            # The initial screen is set from the on_start method in main.py
            SplashScreen:
                name: 'splash'
            JerryScreen:
                name: 'jerry'
            CheckinScreen:
                name: 'checkin'
            CBTScreen:
                name: 'cbt'
            DBTScreen:
                name: 'dbt'
            EntriesScreen:
                name: 'entries'
            HistoryScreen:
                name: 'history'
            HushScreen:
                name: 'hush'

# --- Screen Layout Definitions ---

# These rules now just apply to the existing Python classes
# without re-declaring them. This is the main fix.

<SplashScreen>:
    Label:
        text: 'HushOS'
        font_size: '48sp'

<JerryScreen>:
    BoxLayout:
        orientation: 'vertical'

        # This top section now has a fixed height
        BoxLayout:
            orientation: 'vertical'
            padding: dp(10)
            spacing: dp(10)
            size_hint_y: None
            height: self.minimum_height # Height is determined by its children

            JerryAnimator:
                id: animator
                size_hint_y: None
                height: dp(120)
            
            GridLayout:
                cols: 2
                size_hint_y: None
                height: dp(80)
                spacing: dp(10)
                Label:
                    text: 'Clarity'
                ProgressBar:
                    id: clarity_bar
                    max: 100
                Label:
                    text: 'Insight'
                ProgressBar:
                    id: insight_bar
                    max: 100
                Label:
                    text: 'Calm'
                ProgressBar:
                    id: calm_bar
                    max: 100

            BoxLayout:
                size_hint_y: None
                height: dp(25)
                Label:
                    id: level_label
                ProgressBar:
                    id: xp_bar
                    size_hint_y: None
                    height: dp(10)
                    max: 100
        
        # This ScrollView now takes up all the remaining vertical space
        ScrollView:
            size_hint_y: 1 
            Label:
                id: chat_log
                markup: True
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width - dp(20), None
                padding: dp(10), dp(10)
        
        # The input bar already has a fixed height, which is correct
        BoxLayout:
            size_hint_y: None
            height: dp(48)
            padding: dp(8)
            spacing: dp(8)
            TextInput:
                id: user_entry
                multiline: False
                on_text_validate: root.send_message()
            Button:
                id: send_button
                text: 'Send'
                size_hint_x: None
                width: dp(80)
                on_press: root.send_message()

<TherapyScreenBase>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        TitleLabel:
            id: title_label
            text: "Therapy Worksheet"
            halign: 'center'
        ScrollView:
            size_hint: 1, 1
            GridLayout:
                id: content_box
                cols: 1
                size_hint_y: None
                spacing: dp(10)
                height: self.minimum_height
        BoxLayout:
            size_hint_y: None
            height: dp(50)
            spacing: dp(10)
            Button:
                text: "Back"
                on_press: root.prev_step()
                disabled: root.flow_step == 0
            Button:
                id: next_button
                text: "Next"
                on_press: root.next_step()

<CheckinScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        TitleLabel:
            id: checkin_title_label
            text: "How are you feeling?"
            halign: 'center'
        ProgressBar:
            id: progress_bar
            size_hint_y: None
            height: dp(10)
            max: 100
        Widget:
            size_hint_y: 0.2
        BoxLayout:
            id: checkin_content
            orientation: 'vertical'
            size_hint: 1, 1
        Widget:
            size_hint_y: 0.2

<CBTScreen>:
    # This class is defined in Python and inherits from TherapyScreenBase
    # Its visuals are entirely controlled by the TherapyScreenBase rule above.
    # So we don't need a specific rule for it, but this placeholder can stay.
    
<DBTScreen>:
    # Same as CBTScreen

<EntriesScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: "Your Journal Entries"
            font_size: '24sp'
        BodyScrollView:
            id: entries_log

<HistoryScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: "Conversation History"
            font_size: '24sp'
        BodyScrollView:
            id: history_log

<HushScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        Label:
            text: "Find a moment of peace"
            font_size: '24sp'
        Label:
            id: timer_label
            text: root.get_timer_text()
            font_size: '48sp'
        Button:
            text: "Start Timer" if not root.timer_active else "Stop Timer"
            size_hint_y: None
            height: dp(50)
            on_press: root.start_stop_timer()
