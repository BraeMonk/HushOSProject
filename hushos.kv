#:kivy 1.11.1
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp

#=============================================================================
# BASE WIDGET STYLES
#=============================================================================

<NavDrawerItem@MDNavigationDrawerItem>:
    screen_name: ''
    icon: ''
    text: ''
    theme_text_color: "Custom"
    text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
    on_release: app.change_screen(self.screen_name)

<ColorProgressBar@ProgressBar>:
    bar_color: 0, 0, 0, 1
    canvas:
        Clear
        Color:
            rgba: 0, 0, 0, 0.1 # Background of the bar track
        Rectangle:
            pos: self.x, self.center_y - 5
            size: self.width, 10
        Color:
            rgba: self.bar_color
        Rectangle:
            pos: self.x, self.center_y - 5
            size: self.width * self.value_normalized, 10

<Screen>:
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['background']) if app else (1, 1, 1, 1)
        Rectangle:
            pos: self.pos
            size: self.size

#=============================================================================
# ROOT WIDGET
# Contains the main structure: a single Top Bar, the Screen Manager, and the Drawer.
#=============================================================================

<RootWidget>:
    MDBoxLayout:
        orientation: 'vertical'

        MDTopAppBar:
            title: "HushOS Tools"
            left_action_items: [["menu", lambda x: nav_drawer.set_state("open")]]
            elevation: 4
            md_bg_color: get_color_from_hex(app.theme.COLORS['navbar'])
            specific_text_color: get_color_from_hex(app.theme.COLORS['text_dark'])

        MDNavigationLayout:
            ScreenManager:
                id: sm
                SplashScreen:
                    name: 'splash'
                JerryScreen:
                    name: 'jerry'
                CheckinScreen:
                    name: 'checkin'
                CBTScreen:
                    name: 'cbt'
                DBTScreen:
                    name: 'dbt'
                EntriesScreen:
                    name: 'entries'
                HistoryScreen:
                    name: 'history'
                HushScreen:
                    name: 'hush'
            
            MDNavigationDrawer:
                id: nav_drawer
                md_bg_color: get_color_from_hex(app.theme.COLORS['background'])
                
                MDNavigationDrawerMenu:
                    MDNavigationDrawerHeader:
                        title: "Menu"
                        theme_title_color: "Custom"
                        title_color: get_color_from_hex(app.theme.COLORS['text_dark'])
                    
                    # ... All your NavDrawerItems go here ...
                    NavDrawerItem:
                        text: "Jerry"
                        icon: "robot-happy-outline"
                        screen_name: 'jerry'
                    NavDrawerItem:
                        text: "Check-in"
                        icon: "emoticon-happy-outline"
                        screen_name: 'checkin'
                    NavDrawerItem:
                        text: "CBT Worksheet"
                        icon: "notebook-edit-outline"
                        screen_name: 'cbt'
                    NavDrawerItem:
                        text: "DBT Skills Log"
                        icon: "notebook-check-outline"
                        screen_name: 'dbt'
                    NavDrawerItem:
                        text: "All Entries"
                        icon: "book-open-variant"
                        screen_name: 'entries'
                    NavDrawerItem:
                        text: "Conversation History"
                        icon: "history"
                        screen_name: 'history'
                    NavDrawerItem:
                        text: "Hush"
                        icon: "timer-sand"
                        screen_name: 'hush'
                    
                    MDNavigationDrawerDivider:
                    MDLabel:
                        text: "Version 1.0"
                        font_style: "Caption"
                        halign: "center"
                        padding_y: "12dp"
                        theme_text_color: "Custom"
                        text_color: get_color_from_hex(app.theme.COLORS['text_dark'])

#=============================================================================
# FULL SCREEN DEFINITIONS
# These are now simplified and only contain their specific content.
#=============================================================================

<SplashScreen>:
    MDLabel:
        text: 'HushOS'
        font_style: 'H2'
        halign: 'center'
        theme_text_color: "Custom"
        text_color: get_color_from_hex(app.theme.COLORS['text_dark'])

<JerryScreen>:
    MDBoxLayout:
        orientation: 'vertical'

        MDBoxLayout:
            orientation: 'horizontal'
            size_hint_y: None
            height: dp(150)
            spacing: dp(10)
            padding: [dp(20), dp(10)]
            
            # Jerry animation on the left
            MDBoxLayout:
                size_hint_x: 0.4
                JerryAnimator:
                    id: animator
                    size_hint: None, None
                    size: dp(140), dp(120)
                    pos_hint: {'center_x': 0.5, 'center_y': 0.5}
            
            # Stat block on the right
            MDCard:
                orientation: 'vertical'
                size_hint_x: 0.6
                elevation: 4
                padding: dp(8)
                spacing: dp(8)
                radius: [12, 12, 12, 12]
                md_bg_color: get_color_from_hex(app.theme.COLORS['background'])
                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: dp(80)
                    spacing: dp(10)
                    MDLabel:
                        text: 'Clarity'
                        theme_text_color: "Custom"
                        text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
                    ColorProgressBar:
                        id: clarity_bar
                        max: 100
                        bar_color: get_color_from_hex(app.theme.COLORS['clarity_bar'])
                    MDLabel:
                        text: 'Insight'
                        theme_text_color: "Custom"
                        text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
                    ColorProgressBar:
                        id: insight_bar
                        max: 100
                        bar_color: get_color_from_hex(app.theme.COLORS['insight_bar'])
                    MDLabel:
                        text: 'Calm'
                        theme_text_color: "Custom"
                        text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
                    ColorProgressBar:
                        id: calm_bar
                        max: 100
                        bar_color: get_color_from_hex(app.theme.COLORS['calm_bar'])
                MDBoxLayout:
                    size_hint_y: None
                    height: dp(25)
                    MDLabel:
                        id: level_label
                        theme_text_color: "Custom"
                        text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
                    ColorProgressBar:
                        id: xp_bar
                        max: 100
                        bar_color: get_color_from_hex(app.theme.COLORS['accent'])

        ScrollView:
            MDLabel:
                id: chat_log
                markup: True
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width - dp(20), None
                padding: dp(10)

        MDBoxLayout:
            size_hint_y: None
            height: dp(56)
            padding: dp(8)
            spacing: dp(8)
            MDTextField:
                id: user_entry
                multiline: False
                hint_text: "Talk to Jerry..."
                on_text_validate: root.send_message()
            MDIconButton:
                id: send_button
                icon: "send"
                on_release: root.send_message()

<TherapyScreenBase>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        MDLabel:
            id: title_label
            font_style: 'H4'
            halign: 'center'
            adaptive_height: True
            theme_text_color: "Custom"
            text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ScrollView:
            GridLayout:
                id: content_box
                cols: 1
                adaptive_height: True
                spacing: dp(10)
        MDBoxLayout:
            size_hint_y: None
            height: dp(50)
            spacing: dp(10)
            adaptive_size: True
            pos_hint: {"center_x": 0.5}
            MDFillRoundFlatButton:
                text: "Back"
                on_release: root.prev_step()
                disabled: root.flow_step == 0
            MDFillRoundFlatButton:
                id: next_button
                text: "Next"
                on_release: root.next_step()

<CheckinScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        MDLabel:
            id: checkin_title_label
            text: "How are you feeling?"
            halign: 'center'
            font_style: 'H4'
            adaptive_height: True
            theme_text_color: "Custom"
            text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ColorProgressBar:
            id: progress_bar
            size_hint_y: None
            height: dp(10)
            max: 100
            bar_color: get_color_from_hex(app.theme.COLORS['accent'])
        Widget:
            size_hint_y: 0.2
        ScrollView:
            GridLayout:
                id: checkin_content
                adaptive_height: True
                cols: 1
                spacing: dp(10)
        Widget:
            size_hint_y: 0.2

<CBTScreen(TherapyScreenBase)>:
<DBTScreen(TherapyScreenBase)>:

<EntriesScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(10)
        MDLabel:
            text: "Your Journal Entries"
            font_style: 'H4'
            adaptive_height: True
            theme_text_color: "Custom"
            text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ScrollView:
            id: entries_log
            MDLabel:
                id: entries_text
                markup: True
                adaptive_height: True
                text_size: self.width - dp(20), None
                theme_text_color: "Custom"
                text_color: get_color_from_hex(app.theme.COLORS['text_dark'])

<HistoryScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(10)
        MDLabel:
            text: "Conversation History"
            font_style: 'H4'
            adaptive_height: True
            theme_text_color: "Custom"
            text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ScrollView:
            id: history_log
            MDLabel:
                id: history_text
                markup: True
                adaptive_height: True
                text_size: self.width - dp(20), None
                theme_text_color: "Custom"
                text_color: get_color_from_hex(app.theme.COLORS['text_dark'])

<HushScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        adaptive_size: True
        pos_hint: {'center_x': .5, 'center_y': .5}
        MDLabel:
            text: "Find a moment of peace"
            font_style: 'H4'
            halign: 'center'
            adaptive_height: True
            theme_text_color: "Custom"
            text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
        MDLabel:
            id: timer_label
            text: root.get_timer_text()
            font_style: 'H2'
            halign: 'center'
            adaptive_height: True
            theme_text_color: "Custom"
            text_color: get_color_from_hex(app.theme.COLORS['text_dark'])
        MDFillRoundFlatButton:
            text: "Start Timer" if not root.timer_active else "Stop Timer"
            on_release: root.start_stop_timer()
            pos_hint: {'center_x': 0.5}
