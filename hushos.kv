#:kivy 1.11.1
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp

# --- Reusable Component & Base Class Definitions ---

<NavDrawerButton@Button>:
    screen_name: ''
    size_hint_y: None
    height: dp(56)
    background_color: 0, 0, 0, 0
    background_normal: ''
    on_press: app.change_screen(self.screen_name)
    text_size: self.width - dp(32), None
    halign: 'left'
    valign: 'middle'
    color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

<BaseScreen@Screen>:
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['background']) if app else (0.53, 0.81, 0.98, 1)
        Rectangle:
            pos: self.pos
            size: self.size

<TitleLabel@Label>:
    font_size: '24sp'
    size_hint_y: None
    height: self.texture_size[1]
    color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

<BodyScrollView@ScrollView>:
    Label:
        id: body_text
        markup: True
        size_hint_y: None
        height: self.texture_size[1]
        text_size: self.width - dp(20), None
        color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

# --- Root Widget Definition ---

<RootWidget@FloatLayout>:
    drawer_open: False
    
    BoxLayout:
        orientation: 'vertical'
        size_hint: 1, 1

        # TOP BAR
        BoxLayout:
            size_hint_y: None
            height: dp(56)
            padding: dp(8)
            spacing: dp(8)
            canvas.before:
                Color:
                    rgba: get_color_from_hex(app.theme.COLORS['navbar']) if app else (0.7, 0.9, 1, 1)
                Rectangle:
                    pos: self.pos
                    size: self.size
            Button:
                text: "\u2630" # Hamburger menu icon
                size_hint_x: None
                width: dp(50)
                on_press: root.toggle_drawer()
                background_color: 0, 0, 0, 0
                font_size: '24sp'
            Label:
                text: "HushOS Tools"
                font_size: '20sp'

        # AFFIRMATION BANNER (was missing)
        Label:
            id: affirmation_banner
            size_hint_y: None
            height: 0 # Hidden by default
            text_size: self.width - dp(20), None
            valign: 'middle'
            halign: 'center'

        ScreenManager:
            id: sm
            current: 'splash' # Start on the splash screen
            # ADDED SplashScreen
            SplashScreen:
                name: 'splash'
            JerryScreen:
                name: 'jerry'
            CheckinScreen:
                name: 'checkin'
            CBTScreen:
                name: 'cbt'
            DBTScreen:
                name: 'dbt'
            EntriesScreen:
                name: 'entries'
            HistoryScreen:
                name: 'history'
            HushScreen:
                name: 'hush'

    # NAVIGATION DRAWER
    BoxLayout:
        id: drawer
        orientation: 'vertical'
        size_hint_x: None
        width: dp(280)
        pos_hint: {'x': -1, 'y': 0}
        height: self.parent.height
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['background']) if app else (0.9, 0.9, 0.9, 1)
            Rectangle:
                pos: self.pos
                size: self.size

        TitleLabel:
            text: "Menu"
            padding: dp(16), dp(16)

        NavDrawerButton:
            text: "Jerry"
            screen_name: 'jerry'
        NavDrawerButton:
            text: "Check-in"
            screen_name: 'checkin'
        NavDrawerButton:
            text: "CBT Worksheet"
            screen_name: 'cbt'
        NavDrawerButton:
            text: "DBT Skills Log"
            screen_name: 'dbt'
        NavDrawerButton:
            text: "All Entries"
            screen_name: 'entries'
        NavDrawerButton:
            text: "Conversation History"
            screen_name: 'history'
        NavDrawerButton:
            text: "Hush"
            screen_name: 'hush'

        Widget: # Spacer
        Label:
            text: "Version 1.0"
            font_size: '12sp'
            size_hint_y: None
            height: dp(24)
            color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

# --- Screen Layout Definitions ---

<SplashScreen@BaseScreen>:
    Label:
        text: 'HushOS'
        font_size: '48sp'

<JerryScreen@BaseScreen>:
    # Single root layout for the entire screen
    BoxLayout:
        orientation: 'vertical'
        
        # Top bar with padding, defined within the main layout
        BoxLayout:
            orientation: 'vertical'
            padding: dp(10)
            spacing: dp(10)

            JerryAnimator:
                id: animator
                size_hint_y: None
                height: dp(120)
            
            GridLayout:
                cols: 2
                size_hint_y: None
                height: dp(80)
                spacing: dp(10)
                Label:
                    text: 'Clarity'
                ProgressBar:
                    id: clarity_bar
                    max: 100
                Label:
                    text: 'Insight'
                ProgressBar:
                    id: insight_bar
                    max: 100
                Label:
                    text: 'Calm'
                ProgressBar:
                    id: calm_bar
                    max: 100

            BoxLayout:
                size_hint_y: None
                height: dp(25)
                Label:
                    id: level_label
                ProgressBar:
                    id: xp_bar
                    size_hint_y: None
                    height: dp(10)
                    max: 100
        
        # The ScrollView now takes up the remaining space
        ScrollView:
            size_hint: 1, 1
            Label:
                id: chat_log
                markup: True
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width - dp(20), None
                padding: dp(10), dp(10)
        
        # The input bar, now correctly at the bottom of the main layout
        BoxLayout:
            size_hint_y: None
            height: dp(48)
            padding: dp(8)
            spacing: dp(8)
            TextInput:
                id: user_entry
                multiline: False
                on_text_validate: root.send_message()
            Button:
                id: send_button 
                text: 'Send'
                size_hint_x: None
                width: dp(80)
                on_press: root.send_message()

<CheckinScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: "How are you feeling today?"
            font_size: '24sp'
        GridLayout:
            cols: 2
            spacing: dp(10)
            size_hint_y: None
            height: dp(200)
            Button:
                text: "üòä Good"
            Button:
                text: "üòê Okay"
            Button:
                text: "üòû Bad"
            Button:
                text: "üò° Angry"

<CBTScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: "CBT Thought Tracker"
            font_size: '24sp'
        TextInput:
            hint_text: "Describe your thought..."
            multiline: True
            size_hint_y: None
            height: dp(150)
        Button:
            text: "Save Entry"
            size_hint_y: None
            height: dp(50)

<DBTScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: "DBT Skills Practice"
            font_size: '24sp'
        TextInput:
            hint_text: "Which skill will you practice today?"
            multiline: True
            size_hint_y: None
            height: dp(150)
        Button:
            text: "Log Skill"
            size_hint_y: None
            height: dp(50)

<EntriesScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: "Your Journal Entries"
            font_size: '24sp'
        # CORRECTED: Use the custom BodyScrollView
        BodyScrollView:
            id: entries_log

<HistoryScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        Label:
            text: "Conversation History"
            font_size: '24sp'
        # CORRECTED: Use the custom BodyScrollView
        BodyScrollView:
            id: history_log

<HushScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        Label:
            text: "Find a moment of peace"
            font_size: '24sp'
        Label:
            id: timer_label
            text: root.get_timer_text()
            font_size: '48sp'
        Button:
            text: "Start Timer" if not root.timer_active else "Stop Timer"
            size_hint_y: None
            height: dp(50)
            on_press: root.start_stop_timer()
