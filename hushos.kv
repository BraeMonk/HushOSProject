#:kivy 1.11.1
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp

<Screen>:
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['background']) if app else (0.53, 0.81, 0.98, 1)
        Rectangle:
            pos: self.pos
            size: self.size

<TitleLabel@Label>:
    font_size: '24sp'
    size_hint_y: None
    height: self.texture_size[1]
    color: get_color_from_hex(app.theme.COLORS['text_dark']) if app else (0, 0, 0, 1)

<BodyScrollView@ScrollView>:
    MDBoxLayout:
        id: body_box
        orientation: 'vertical'
        adaptive_height: True
        padding: dp(10)
        spacing: dp(10)

<RootWidget>:
    MDNavigationLayout:

        # --- 1. Main Content Screen ---
        MDScreen:
            MDBoxLayout:
                orientation: 'vertical'

                MDTopAppBar:
                    title: "HushOS Tools"
                    left_action_items: [["menu", lambda x: nav_drawer.set_state("open")]]
                    elevation: 4

                MDLabel:
                    id: affirmation_banner
                    size_hint_y: None
                    height: 0
                    halign: 'center'

                ScreenManager:
                    id: sm
                    SplashScreen:
                        name: 'splash'
                    JerryScreen:
                        name: 'jerry'
                    CheckinScreen:
                        name: 'checkin'
                    CBTScreen:
                        name: 'cbt'
                    DBTScreen:
                        name: 'dbt'
                    EntriesScreen:
                        name: 'entries'
                    HistoryScreen:
                        name: 'history'
                    HushScreen:
                        name: 'hush'

        # --- 2. Navigation Drawer Panel ---
        MDNavigationDrawer:
            id: nav_drawer
            radius: (0, 16, 16, 0)

            MDNavigationDrawerMenu:
                MDNavigationDrawerHeader:
                    title: "Menu"
                MDNavigationDrawerItem:
                    text: "Jerry"
                    icon: "robot-happy-outline"
                    on_release: app.change_screen('jerry')
                MDNavigationDrawerItem:
                    text: "Check-in"
                    icon: "emoticon-happy-outline"
                    on_release: app.change_screen('checkin')
                MDNavigationDrawerItem:
                    text: "CBT Worksheet"
                    icon: "notebook-edit-outline"
                    on_release: app.change_screen('cbt')
                MDNavigationDrawerItem:
                    text: "DBT Skills Log"
                    icon: "notebook-check-outline"
                    on_release: app.change_screen('dbt')
                MDNavigationDrawerItem:
                    text: "All Entries"
                    icon: "book-open-variant"
                    on_release: app.change_screen('entries')
                MDNavigationDrawerItem:
                    text: "Conversation History"
                    icon: "history"
                    on_release: app.change_screen('history')
                MDNavigationDrawerItem:
                    text: "Hush"
                    icon: "timer-sand"
                    on_release: app.change_screen('hush')
                MDNavigationDrawerDivider:
                MDLabel:
                    text: "Version 1.0"
                    font_style: "Caption"
                    halign: "center"
                    size_hint_y: None
                    height: self.texture_size[1]
                    padding_y: "12dp"
                    
# --- Screen Layout Definitions (No changes needed below this line) ---

<SplashScreen>:
    MDLabel:
        text: 'HushOS'
        font_style: 'H2'
        halign: 'center'

<JerryScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        spacing: dp(10)
        
        JerryAnimator:
            id: animator
            size_hint_y: None
            height: dp(120)
            
        GridLayout:
            cols: 2
            size_hint_y: None
            height: dp(80)
            spacing: dp(10)
            MDLabel:
                text: 'Clarity'
            ProgressBar:
                id: clarity_bar
                max: 100
            MDLabel:
                text: 'Insight'
            ProgressBar:
                id: insight_bar
                max: 100
            MDLabel:
                text: 'Calm'
            ProgressBar:
                id: calm_bar
                max: 100
        
        MDBoxLayout:
            size_hint_y: None
            height: dp(25)
            MDLabel:
                id: level_label
            ProgressBar:
                id: xp_bar
                max: 100
        
        ScrollView:
            id: chat_scroll
            MDLabel:
                id: chat_log
                markup: True
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width - dp(20), None
                
        MDBoxLayout:
            size_hint_y: None
            height: dp(48)
            padding: dp(8)
            spacing: dp(8)
            TextInput:
                id: user_entry
                multiline: False
                on_text_validate: root.send_message()
            MDFillRoundFlatButton:
                id: send_button
                text: 'Send'
                on_release: root.send_message()
<TherapyScreenBase>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        TitleLabel:
            id: title_label
            text: "Therapy Worksheet"
            halign: 'center'
        ScrollView:
            GridLayout:
                id: content_box
                cols: 1
                adaptive_height: True
                spacing: dp(10)
        MDBoxLayout:
            size_hint_y: None
            height: dp(50)
            spacing: dp(10)
            adaptive_width: True
            pos_hint: {"center_x": 0.5}
            MDFillRoundFlatButton:
                text: "Back"
                on_release: root.prev_step()
                disabled: root.flow_step == 0
            MDFillRoundFlatButton:
                id: next_button
                text: "Next"
                on_release: root.next_step()
<CheckinScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        TitleLabel:
            id: checkin_title_label
            text: "How are you feeling?"
            halign: 'center'
        ProgressBar:
            id: progress_bar
            size_hint_y: None
            height: dp(10)
            max: 100
        Widget:
            size_hint_y: 0.2
        ScrollView:
            GridLayout:
                id: checkin_content
                adaptive_height: True
                cols: 1
                spacing: dp(10)
        Widget:
            size_hint_y: 0.2

<CBTScreen>:
<DBTScreen>:

<EntriesScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(10)
        MDLabel:
            text: "Your Journal Entries"
            font_style: 'H4'
            adaptive_height: True
        BodyScrollView:
            id: entries_log

<HistoryScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(10)
        MDLabel:
            text: "Conversation History"
            font_style: 'H4'
            adaptive_height: True
        BodyScrollView:
            id: history_log

<HushScreen>:
    MDBoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        MDLabel:
            text: "Find a moment of peace"
            font_style: 'H4'
            halign: 'center'
            adaptive_height: True
        MDLabel:
            id: timer_label
            text: root.get_timer_text()
            font_style: 'H2'
            halign: 'center'
        MDFillRoundFlatButton:
            text: "Start Timer" if not root.timer_active else "Stop Timer"
            on_release: root.start_stop_timer()
            pos_hint: {'center_x': 0.5}
