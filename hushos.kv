#:kivy 1.11.1
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp
#:import FadeTransition kivy.uix.screenmanager.FadeTransition
#:import NavigationDrawer navigationdrawer.NavigationDrawer
#:import Window kivy.core.window.Window

# --- Custom Buttons ---

# Button for the bottom navigation bar
<NavButton@ToggleButton>:
    background_color: 0,0,0,0 # Transparent background
    background_normal: ''
    background_down: '' # No visual change on press, handled by color
    size_hint_y: 1
    font_size: '12sp'
    group: 'nav' # Ensures only one can be active at a time
    on_press: app.change_screen(self.screen_name)
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['accent']) if self.state == 'down' else (0,0,0,0)
        Rectangle:
            size: self.size
            pos: self.pos

# Button for the new side navigation drawer
<NavDrawerButton@Button>:
    size_hint_y: None
    height: dp(56)
    background_color: 0,0,0,0
    background_normal: ''
    on_press: app.change_screen(self.screen_name)
    text_size: self.width - dp(32), None # Add padding
    halign: 'left'
    valign: 'middle'
    color: get_color_from_hex(app.theme.COLORS['text_dark'])

# --- Base Layout for Therapy Screens ---
<TherapyScreenBase>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['background'])
            Rectangle:
                pos: self.pos
                size: self.size

        Label:
            id: title_label
            font_size: '22sp'
            size_hint_y: None
            height: self.texture_size[1]
            text_size: self.width, None
            halign: 'center'
            color: get_color_from_hex(app.theme.COLORS['text_dark'])

        ScrollView:
            id: content_scroll
            size_hint_y: 1
            do_scroll_x: False
            bar_width: dp(10)
            BoxLayout:
                id: content_box
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(10)

        BoxLayout:
            size_hint_y: None
            height: dp(50)
            spacing: dp(10)
            Button:
                id: back_button
                text: 'Back'
                on_press: root.prev_step()
                opacity: 1 if root.flow_step > 0 else 0
                disabled: root.flow_step == 0
            Button:
                id: next_button
                text: 'Next'
                on_press: root.next_step()

# --- Root Widget: The Navigation Layout ---
<RootWidget>:
    id: nav_drawer
    side_panel_width: min(dp(280), Window.width * 0.7) # Responsive width
    anim_type: 'slide_above_anim'

    # --- 1. The Side Panel (Navigation Drawer Content) ---
    BoxLayout:
        id: side_panel
        orientation: 'vertical'
        padding: dp(8)
        spacing: dp(8)
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['background'])
            Rectangle:
                pos: self.pos
                size: self.size
        
        Label:
            text: "HushOS Tools"
            font_size: '20sp'
            size_hint_y: None
            height: dp(48)
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
        
        NavDrawerButton:
            text: "Conversation History"
            screen_name: "history"
        NavDrawerButton:
            text: "CBT Worksheet"
            screen_name: "cbt"
        NavDrawerButton:
            text: "DBT Skills Log"
            screen_name: "dbt"
        
        Widget:

        Label:
            text: "Version 1.0"
            font_size: '12sp'
            size_hint_y: None
            height: dp(24)
            color: get_color_from_hex(app.theme.COLORS['text_dark'])

    # --- 2. The Main Application Content ---
    BoxLayout:
        id: main_content
        orientation: 'vertical'
        canvas.before:
            Color:
                rgba: get_color_from_hex(app.theme.COLORS['background'])
            Rectangle:
                pos: self.pos
                size: self.size
        
        BoxLayout:
            id: top_bar
            size_hint_y: None
            height: dp(56)
            padding: dp(8)
            canvas.before:
                Color:
                    rgba: get_color_from_hex(app.theme.COLORS['navbar'])
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            Button:
                background_normal: 'assets/menu.png'
                background_down: 'assets/menu.png'  # Use the same image for the pressed state
                size_hint_x: None
                width: dp(48)  # Adjusted for a more icon-like feel
                height: dp(48)
                pos_hint: {'center_y': 0.5}
                border: 0, 0, 0, 0 # Removes the default button border
                on_press: nav_drawer.set_state('toggle')

            Label:
                id: top_bar_title
                text: 'HushOS'
                font_size: '24sp'
                color: get_color_from_hex(app.theme.COLORS['text_light'])

        ScreenManager:
            id: sm
            transition: FadeTransition(duration=0.2)
            SplashScreen:
                name: 'splash'
            JerryScreen:
                name: 'jerry'
            CheckinScreen:
                name: 'checkin'
            EntriesScreen:
                name: 'entries'
            HistoryScreen:
                name: 'history'
            HushScreen:
                name: 'hush'
            # --- The new screens will be added here by the manager ---
            CBTScreen:
                name: 'cbt'
            DBTScreen:
                name: 'dbt'

        Label:
            id: affirmation_banner
            size_hint_y: None
            height: 0
            text: ""
            canvas.before:
                Color:
                    rgba: get_color_from_hex(app.theme.COLORS['accent'])
                Rectangle:
                    pos: self.pos
                    size: self.size
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
            text_size: self.width - dp(20), None
            halign: 'center'
            valign: 'middle'

        BoxLayout:
            id: nav_bar
            size_hint_y: None
            height: dp(60)
            canvas.before:
                Color:
                    rgba: get_color_from_hex(app.theme.COLORS['navbar'])
                Rectangle:
                    pos: self.pos
                    size: self.size
            
            NavButton:
                text: 'Home'
                screen_name: 'jerry'
                state: 'down'
            NavButton:
                text: 'Check-in'
                screen_name: 'checkin'
            NavButton:
                text: 'Entries'
                screen_name: 'entries'
            NavButton:
                text: 'Hush'
                screen_name: 'hush'

# --- Screen Definitions ---

<SplashScreen>:
    canvas.before:
        Color:
            rgba: get_color_from_hex(app.theme.COLORS['navbar'])
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        text: "Hush OS"
        font_size: '60sp'
        bold: True
        color: get_color_from_hex(app.theme.COLORS['text_light'])

<JerryScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        spacing: dp(10)
        
        JerryAnimator:
            id: animator
            size_hint_y: None
            height: dp(120)

        GridLayout:
            cols: 2
            size_hint_y: None
            height: dp(80)
            spacing: dp(10)
            Label:
                text: 'Clarity'
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
            ProgressBar:
                id: clarity_bar
                max: 100
            Label:
                text: 'Insight'
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
            ProgressBar:
                id: insight_bar
                max: 100
            Label:
                text: 'Calm'
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
            ProgressBar:
                id: calm_bar
                max: 100

        BoxLayout:
            size_hint_y: None
            height: dp(25)
            orientation: 'vertical'
            Label:
                id: level_label
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
            ProgressBar:
                id: xp_bar
                size_hint_y: None
                height: dp(10)
                max: 100

        ScrollView:
            size_hint_y: 1
            canvas.before:
                Color:
                    rgba: get_color_from_hex(app.theme.COLORS['chat_bg'])
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                id: chat_log
                text: ""
                markup: True
                font_size: '14sp'
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width, None
                padding: dp(10), dp(10)

        BoxLayout:
            size_hint_y: None
            height: dp(48)
            TextInput:
                id: user_entry
                multiline: False
                on_text_validate: root.send_message()
            Button:
                id: send_button
                text: 'Send'
                size_hint_x: None
                width: dp(80)
                on_press: root.send_message()

<CheckinScreen>:
    canvas.before:
        Color:
            rgba: root.bg_color
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        id: content
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        
        Label:
            id: checkin_title_label
            font_size: '24sp'
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
            size_hint_y: None
            height: dp(100)
            text: "Loading..."

        BoxLayout:
            id: checkin_button_layout
            orientation: 'horizontal'
            spacing: dp(20)
            size_hint_y: None
            height: dp(150)
            padding: [dp(20), 0, dp(20), 0]

<EntriesScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        Label:
            text: 'Your Entries'
            font_size: '24sp'
            size_hint_y: None
            height: dp(40)
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ScrollView:
            Label:
                id: entries_log
                text: ""
                markup: True
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width, None
                padding: dp(10), dp(10)

<HistoryScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        Label:
            text: 'Conversation History'
            font_size: '24sp'
            size_hint_y: None
            height: dp(40)
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
        ScrollView:
            Label:
                id: history_log
                text: ""
                markup: True
                color: get_color_from_hex(app.theme.COLORS['text_dark'])
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width, None
                padding: dp(10), dp(10)

<HushScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        
        Label:
            text: "Find a moment of peace." if not root.timer_active else "Breathe..."
            font_size: '24sp'
            color: get_color_from_hex(app.theme.COLORS['text_dark'])

        Label:
            text: root.get_timer_text()
            font_size: '60sp'
            bold: True
            color: get_color_from_hex(app.theme.COLORS['text_dark'])
            opacity: 1 if root.timer_active else 0

        Button:
            text: "Start 3 Minute Hush Session"
            on_press: root.start_timer()
            opacity: 0 if root.timer_active else 1
            disabled: root.timer_active
            size_hint_y: None
            height: dp(50)

# --- The actual CBT/DBT Screens now inherit from the base class ---
<CBTScreen>:
<DBTScreen>:
