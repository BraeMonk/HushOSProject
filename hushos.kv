#:kivy 1.11.1
#:import get_color_from_hex kivy.utils.get_color_from_hex
#:import dp kivy.metrics.dp
#:import Window kivy.core.window.Window
#:import StringProperty kivy.properties.StringProperty

# --- Reusable Component & Base Class Definitions ---

<NavDrawerButton@Button>:
    screen_name: ''
    size_hint_y: None
    height: dp(56)
    background_color: (0, 0, 0, 0)
    background_normal: ''
    on_press: app.change_screen(self.screen_name)
    text_size: self.width - dp(32), None
    halign: 'left'
    valign: 'middle'
    color: app.theme.COLORS['text_dark'] if app else (0,0,0,1)

<BaseScreen@Screen>:
    canvas.before:
        Color:
            rgba: app.theme.COLORS['background'] if app else (.9,.9,.9,1)
        Rectangle:
            pos: self.pos
            size: self.size

<TitleLabel@Label>:
    font_size: '24sp'
    size_hint_y: None
    height: self.texture_size[1]
    color: app.theme.COLORS['text_dark'] if app else (0,0,0,1)

<BodyScrollView@ScrollView>:
    Label:
        id: body_text
        markup: True
        size_hint_y: None
        height: self.texture_size[1]
        text_size: self.width - dp(20), None
        color: app.theme.COLORS['text_dark'] if app else (0,0,0,1)

# --- Root Widget Definition ---

<RootWidget>:
    id: nav_drawer
    side_panel_width: min(dp(280), Window.width * 0.7)
    anim_type: 'slide_above_anim'

    side_panel:
        BoxLayout:
        orientation: 'vertical'
        padding: dp(8)
        spacing: dp(8)
        canvas.before:
        Color:
        rgba: app.theme.COLORS['background'] if app else (.9, .9, .9, 1)
        Rectangle:
        pos: self.pos
        size: self.size
        TitleLabel:
        text: "HushOS Tools"
        font_size: '20sp'
        NavDrawerButton:
        text: "Jerry"
        screen_name: 'jerry'
        NavDrawerButton:
        text: "Check-in"
        screen_name: 'checkin'
        NavDrawerButton:
        text: "Conversation History"
        screen_name: 'history'
        NavDrawerButton:
        text: "CBT Worksheet"
        screen_name: 'cbt'
        NavDrawerButton:
        text: "DBT Skills Log"
        screen_name: 'dbt'
        NavDrawerButton:
        text: "All Entries"
        screen_name: 'entries'
        NavDrawerButton:
        text: "Hush"
        screen_name: 'hush'
        Widget:
        Label:
            text: "Version 1.0"
            font_size: '12sp'
            size_hint_y: None
            height: dp(24)
            color: app.theme.COLORS['text_dark'] if app else (0,0,0,1)

    main_panel:
        BoxLayout:
        orientation: 'vertical'
        Label:
            id: affirmation_banner
            size_hint_y: None
            height: 0
            text: ""
            canvas.before:
            Color:
            rgba: app.theme.COLORS['accent'] if app else (.8,.8,.8,1)
            Rectangle:
            pos: self.pos
            size: self.size
            color: app.theme.COLORS['text_dark'] if app else (0,0,0,1)
            text_size: self.width - dp(20), None
            halign: 'center'
            valign: 'middle'
            ScreenManager:
                id: sm
                SplashScreen:
                    name: 'splash'
                JerryScreen:
                    name: 'jerry'
                CheckinScreen:
                    name: 'checkin'
                CBTScreen:
                    name: 'cbt'
                DBTScreen:
                    name: 'dbt'
                EntriesScreen:
                    name: 'entries'
                HistoryScreen:
                    name: 'history'
                HushScreen:
                    name: 'hush'

# --- Screen Layout Definitions ---

<SplashScreen>:
    canvas.before:
        Color:
            rgba: app.theme.COLORS['navbar'] if app else (.2,.2,.6,1)
        Rectangle:
            pos: self.pos
            size: self.size
    Label:
        text: "Hush OS"
        font_size: '60sp'
        bold: True
        color: app.theme.COLORS['text_light'] if app else (1,1,1,1)

<JerryScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        spacing: dp(10)
        JerryAnimator:
            id: animator
            size_hint_y: None
            height: dp(120)
        GridLayout:
            cols: 2
            size_hint_y: None
            height: dp(80)
            spacing: dp(10)
            Label:
                text: 'Clarity'
            ProgressBar:
                id: clarity_bar
                max: 100
            Label:
                text: 'Insight'
            ProgressBar:
                id: insight_bar
                max: 100
            Label:
                text: 'Calm'
            ProgressBar:
                id: calm_bar
                max: 100
        BoxLayout:
            size_hint_y: None
            height: dp(25)
            orientation: 'vertical'
            Label:
                id: level_label
            ProgressBar:
                id: xp_bar
                size_hint_y: None
                height: dp(10)
                max: 100
        ScrollView:
            canvas.before:
                Color:
                    rgba: app.theme.COLORS['chat_bg'] if app else (1,1,1,1)
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                id: chat_log
                markup: True
                font_size: '14sp'
                size_hint_y: None
                height: self.texture_size[1]
                text_size: self.width, None
                padding: dp(10), dp(10)
        BoxLayout:
            size_hint_y: None
            height: dp(48)
            TextInput:
                id: user_entry
                multiline: False
                on_text_validate: root.send_message()
            Button:
                id: send_button
                text: 'Send'
                size_hint_x: None
                width: dp(80)
                on_press: root.send_message()

<CheckinScreen>:
    canvas.before:
        Color:
            rgba: root.bg_color if root.bg_color else (.9,.9,.9,1)
        Rectangle:
            pos: self.pos
            size: self.size
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        Label:
            id: checkin_title_label
            font_size: '24sp'
            size_hint_y: None
            height: dp(100)
            text: "Loading..."
        BoxLayout:
            id: checkin_button_layout
            orientation: 'horizontal'
            spacing: dp(20)
            size_hint_y: None
            height: dp(150)
            padding: [dp(20), 0, dp(20), 0]

<EntriesScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        TitleLabel:
            text: 'Your Entries'
        BodyScrollView:
            id: entries_log

<HistoryScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        TitleLabel:
            text: 'Conversation History'
        BodyScrollView:
            id: history_log

<HushScreen@BaseScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(20)
        Label:
            text: "Find a moment of peace." if not root.timer_active else "Breathe..."
            font_size: '24sp'
        Label:
            text: root.get_timer_text()
            font_size: '60sp'
            bold: True
            opacity: 1 if root.timer_active else 0
        Button:
            text: "Start 3 Minute Hush Session"
            on_press: root.start_timer()
            opacity: 0 if root.timer_active else 1
            disabled: root.timer_active
            size_hint_y: None
            height: dp(50)

<TherapyScreenBase>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(20)
        spacing: dp(15)
        canvas.before:
            Color:
                rgba: app.theme.COLORS['background'] if app else (.9,.9,.9,1)
            Rectangle:
                pos: self.pos
                size: self.size
        TitleLabel:
            id: title_label
            font_size: '22sp'
            halign: 'center'
        ScrollView:
            id: content_scroll
            do_scroll_x: False
            bar_width: dp(10)
            BoxLayout:
                id: content_box
                orientation: 'vertical'
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(10)
        BoxLayout:
            size_hint_y: None
            height: dp(50)
            spacing: dp(10)
            Button:
                id: back_button
                text: 'Back'
                on_press: root.prev_step()
                opacity: 1 if root.flow_step > 0 else 0
                disabled: root.flow_step == 0
            Button:
                id: next_button
                text: 'Next'
                on_press: root.next_step()

<CBTScreen@TherapyScreenBase>:

<DBTScreen@TherapyScreenBase>:
